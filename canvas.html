<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        * {
            padding: 0;
            margin: 0;

        }

        body {
            background: #ddd;
        }

        canvas {
            margin: 10px;
            background: transparent;
            border: thin inset #aaa;
        }

        button {
            width: 200px;
            height: 200px;
        }
    </style>

</head>
<body>
<span>canvas</span>
<canvas id='canvas' width='300' height='300'></canvas>
<span>offScreenCanvasLips</span>
<canvas id='osCanvas1' width='300' height='300'></canvas>
<span>offScreenCanvasFace</span>
<canvas id='osCanvas2' width='300' height='300'></canvas>
<br/>
<span>img</span>
<img width="300" height='300'/>
<button>SEND!!!</button>

<script src='js/jquery-1.8.3.min.js'></script>
<script src='controller/controller.js'></script>
<script>
    onload = function () {
        function windowToCanvas(canvas, clientX, clientY) {
            var boundingRect = canvas.getBoundingClientRect();
            return {
                //鼠标的x-boundingRect的x
                x: (clientX - boundingRect.left) / (boundingRect.width / canvas.width), //boundingRect.width/canvas.width就是放大的倍数
                y: (clientY - boundingRect.top) / (boundingRect.height / canvas.height)
            }

        }

        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');//d必须小写

        var osCanvas1 = document.getElementById('osCanvas1'); //离屏以后会被挡住
        var osContext1 = osCanvas1.getContext('2d');
        var osCanvas2 = document.getElementById('osCanvas2'); //离屏以后会被挡住
        var osContext2 = osCanvas2.getContext('2d');
        var domImg = document.getElementsByTagName('img')[0];


//      initParas.............................................................................................
        var lipsPosition = {x: 0, y: 0};
        var facePosition = {x: 0, y: 0};
        var mouseDown = {x: 0, y: 0};
        var mouseMove = {x: 0, y: 0};
        var dx;
        var dy;

        var ifDragging = false;
        var dataUrl;


        //canvasSource........................................................................................
        var imgArr = [
            {"name": "lips", "src": "img/lips.png"},
            {"name": "face", "src": "img/face.jpg"},
        ];

        var imgLoadedJson = {};
        var loadedImgNum = 0;
        [].forEach.call(imgArr, function (e, i, arr) {
            var image = new Image();
            image.src = e.src;
            var name = e.name;


            image.onload = function () {
                //参数1 哪张图片
                //参数23 截取这张图片的哪个位置
                //参数45 截取这张图片的宽高
                //参数67 这张图放到画布的哪个位置
                //参数89 这张图放到画布的宽高
                loadedImgNum++;
                imgLoadedJson[name] = image;
                if (loadedImgNum == imgArr.length) {
                    //初始化两个离屏图像..............................
                    osContext1.drawImage(imgLoadedJson.lips, 0, 0, 142, 120, lipsPosition.x, lipsPosition.y, 142, 120);
                    osContext2.drawImage(imgLoadedJson.face, 0, 0, 300, 245, lipsPosition.x, lipsPosition.y, 300, 245);

                    drawPng();
                    function drawPng() {

                        var imageData = osContext1.getImageData(0, 0, 300, 300);
                        var imageData2 = osContext2.getImageData(0, 0, 300, 300);


                        //osContext1 1里面存了
                        [].forEach.call(imageData.data, function (e, i, arr) {
                            if (i % 4 == 0) {//0 1 2说明是rgb通道
                                imageData.data[i] = (imageData.data[i] + imageData2.data[i]) / 2;
                            } else if (i % 4 == 1) {//0 1 2说明是rgb通道
                                imageData.data[i] = (imageData.data[i] + imageData2.data[i]) / 2;
                            } else if (i % 4 == 2) {//0 1 2说明是rgb通道
                                imageData.data[i] = (imageData.data[i] + imageData2.data[i]) / 2;
                            } else {//说明是alpha通道
                                if (imageData.data[i] != 0) {
//                                    imageData.data[i] = 255;
                                }
                            }
                        });
                        context.putImageData(imageData, 0, 0);
                        dataUrl = canvas.toDataURL();
//                        console.log(dataUrl)
//                        console.log(dataUrl.substring(22));
                        domImg.src = dataUrl;
                    }

                    var btn = document.getElementsByTagName('button')[0];
                    btn.onclick = function () {
                        controller.postImg({
                            imgString: dataUrl.substring(22)
                        });
                    }

//                    canvas.onmousedown = function (e) {
//                        ifDragging = true;
//                        mouseDown.x = e.clientX;
//                        mouseDown.y = e.clientY;
//                    }
//
//                    canvas.onmousemove = function (e) {
//                        if (ifDragging) {
//                            dx = e.clientX - mouseDown.x;
//                            dy = e.clientY - mouseDown.y;
//
//                            context.clearRect(0, 0, canvas.width, canvas.height);
////                            context.drawImage(imgLoadedJson.face, 0, 0, 1200, 980, facePosition.x + dx, facePosition.y + dy, 1200, 980);
//                            context.drawImage(imgLoadedJson.lips, 0, 0, 454, 340, lipsPosition.x, lipsPosition.y, 454, 340);
//                        }
//                    }
//                    canvas.onmouseup = function (e) {
//                        ifDragging = false;
//                        facePosition.x += dx;
//                        facePosition.y += dy;
//                    }

                }
            }
        });


    }
</script>
</body>
</html>